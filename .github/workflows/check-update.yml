name: Check for AppFlowy Updates

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest AppFlowy release
        id: latest_release
        run: |
          RELEASE_DATA=$(curl -s https://api.github.com/repos/AppFlowy-IO/AppFlowy/releases/latest)
          LATEST_VERSION=$(echo "$RELEASE_DATA" | jq -r .tag_name)
          RELEASE_DATE=$(echo "$RELEASE_DATA" | jq -r .published_at | cut -d'T' -f1)
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "date=$RELEASE_DATE" >> $GITHUB_OUTPUT
          echo "Latest AppFlowy version: $LATEST_VERSION (released on $RELEASE_DATE)"

      - name: Get current version from manifest
        id: current_version
        run: |
          CURRENT_VERSION=$(grep -oP 'AppFlowy-\K[0-9]+\.[0-9]+\.[0-9]+' io.appflowy.AppFlowy.yml | head -1)
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version in manifest: $CURRENT_VERSION"

      - name: Compare versions
        id: compare
        run: |
          LATEST="${{ steps.latest_release.outputs.version }}"
          CURRENT="${{ steps.current_version.outputs.version }}"

          if [ "$LATEST" != "$CURRENT" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "Update available: $CURRENT -> $LATEST"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "Already up to date at version $CURRENT"
          fi

      - name: Download and calculate SHA256
        if: steps.compare.outputs.update_available == 'true'
        id: download
        run: |
          VERSION="${{ steps.latest_release.outputs.version }}"
          URL="https://github.com/AppFlowy-IO/AppFlowy/releases/download/${VERSION}/AppFlowy-${VERSION}-linux-x86_64.tar.gz"

          echo "Downloading from: $URL"
          wget -q "$URL" -O appflowy.tar.gz

          SHA256=$(sha256sum appflowy.tar.gz | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "Calculated SHA256: $SHA256"

          rm appflowy.tar.gz

      - name: Update manifest
        if: steps.compare.outputs.update_available == 'true'
        run: |
          VERSION="${{ steps.latest_release.outputs.version }}"
          SHA256="${{ steps.download.outputs.sha256 }}"

          # Update version in URL
          sed -i "s|AppFlowy-[0-9]*\.[0-9]*\.[0-9]*-linux-x86_64\.tar\.gz|AppFlowy-${VERSION}-linux-x86_64.tar.gz|g" io.appflowy.AppFlowy.yml

          # Update SHA256
          sed -i "s/sha256: [a-f0-9]*/sha256: ${SHA256}/" io.appflowy.AppFlowy.yml

          echo "Manifest updated to version $VERSION"

      - name: Update appdata.xml
        if: steps.compare.outputs.update_available == 'true'
        run: |
          VERSION="${{ steps.latest_release.outputs.version }}"
          RELEASE_DATE="${{ steps.latest_release.outputs.date }}"

          # Add new release entry after <releases> line
          sed -i "/<releases>/a \\\\t\\\\t<release version=\"${VERSION}\" date=\"${RELEASE_DATE}\">\\n\\\\t\\\\t\\\\t<description />\\n\\\\t\\\\t</release>" io.appflowy.AppFlowy.appdata.xml

          echo "AppData updated with release $VERSION ($RELEASE_DATE)"

      - name: Create Pull Request
        if: steps.compare.outputs.update_available == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: bump version ${{ steps.latest_release.outputs.version }}"
          title: "chore: bump version ${{ steps.latest_release.outputs.version }}"
          body: |
            ## Update AppFlowy

            This PR updates AppFlowy from version ${{ steps.current_version.outputs.version }} to ${{ steps.latest_release.outputs.version }}.

            **Changes:**
            - Updated `io.appflowy.AppFlowy.yml`:
              - Updated download URL to new version
              - Updated SHA256 checksum: `${{ steps.download.outputs.sha256 }}`
            - Updated `io.appflowy.AppFlowy.appdata.xml`:
              - Added new release entry for version ${{ steps.latest_release.outputs.version }}
              - Release date: ${{ steps.latest_release.outputs.date }}

            **Release Notes:**
            https://github.com/AppFlowy-IO/AppFlowy/releases/tag/${{ steps.latest_release.outputs.version }}

            ---
            Auto-generated by GitHub Actions
          branch: update-appflowy-${{ steps.latest_release.outputs.version }}
          delete-branch: true

      - name: No update available
        if: steps.compare.outputs.update_available == 'false'
        run: |
          echo "::notice::AppFlowy is already at the latest version ${{ steps.current_version.outputs.version }}"
